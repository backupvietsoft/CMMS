IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'INTEGRATION_NHOM_MAY_UPDATE')
   exec('CREATE PROCEDURE [dbo].[INTEGRATION_NHOM_MAY_UPDATE] AS BEGIN SET NOCOUNT ON; END')
GO
--EXEC INTEGRATION_NHOM_MAY_UPDATE '70000','80000','5000','50000TESTGG','E'
ALTER PROC [dbo].[INTEGRATION_NHOM_MAY_UPDATE]	
	@MS_NHOM_MAY nvarchar(10),
	@MS_NHOM_MAY_CU nvarchar(10),
	@MS_LOAI_MAY nvarchar(10),
	@TEN_NHOM_MAY nvarchar(50),
	@STATUS nvarchar(1)
AS

--Them loai may neu khong ton tai trong bang Loai May
IF NOT EXISTS (SELECT MS_LOAI_MAY FROM LOAI_MAY WHERE MS_LOAI_MAY = @MS_LOAI_MAY)
BEGIN
	INSERT INTO LOAI_MAY (MS_LOAI_MAY,TEN_LOAI_MAY,STT_MAY)
	VALUES (@MS_LOAI_MAY,@TEN_NHOM_MAY,(SELECT ISNULL(MAX(STT_MAY),0) + 1 FROM LOAI_MAY) )

	-- Insert vao nhom loai may
	IF NOT EXISTS (SELECT MS_LOAI_MAY FROM NHOM_LOAI_MAY WHERE MS_LOAI_MAY = @MS_LOAI_MAY AND GROUP_ID = 1)
	BEGIN
		INSERT INTO NHOM_LOAI_MAY (MS_LOAI_MAY,GROUP_ID)
		VALUES (@MS_LOAI_MAY,1)
	END
	
END

IF @STATUS = 'N'
BEGIN
	IF EXISTS (SELECT MS_NHOM_MAY FROM NHOM_MAY WHERE MS_NHOM_MAY = @MS_NHOM_MAY)
	BEGIN
		UPDATE NHOM_MAY SET TEN_NHOM_MAY = @TEN_NHOM_MAY,MS_LOAI_MAY = @MS_LOAI_MAY
		WHERE MS_NHOM_MAY = @MS_NHOM_MAY 
	END
	ELSE
	BEGIN
		INSERT INTO NHOM_MAY (MS_NHOM_MAY,MS_LOAI_MAY,TEN_NHOM_MAY)
		VALUES( @MS_NHOM_MAY, @MS_LOAI_MAY, @TEN_NHOM_MAY)
	END	
END

IF @STATUS = 'E'
BEGIN
	IF @MS_NHOM_MAY <> @MS_NHOM_MAY_CU
	BEGIN
		EXEC spCapNhapMaNhomMay @MS_NHOM_MAY_CU,@MS_NHOM_MAY	
	END

	UPDATE NHOM_MAY SET TEN_NHOM_MAY = @TEN_NHOM_MAY,MS_LOAI_MAY = @MS_LOAI_MAY
	WHERE MS_NHOM_MAY = @MS_NHOM_MAY 
END	

IF @STATUS = 'D'
BEGIN
	IF NOT EXISTS (SELECT TOP 1 MS_MAY FROM MAY WHERE MS_NHOM_MAY = @MS_NHOM_MAY )
	BEGIN
		DELETE NHOM_MAY WHERE MS_NHOM_MAY = @MS_NHOM_MAY 
	END
END


