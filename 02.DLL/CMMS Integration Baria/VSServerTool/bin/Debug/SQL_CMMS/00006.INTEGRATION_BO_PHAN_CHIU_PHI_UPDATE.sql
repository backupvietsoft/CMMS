IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'INTEGRATION_BO_PHAN_CHIU_PHI_UPDATE')
   exec('CREATE PROCEDURE [dbo].[INTEGRATION_BO_PHAN_CHIU_PHI_UPDATE] AS BEGIN SET NOCOUNT ON; END')
GO

ALTER PROC [dbo].[INTEGRATION_BO_PHAN_CHIU_PHI_UPDATE]	
	@MS_BP_CHIU_PHI INT,
	@MS_BP_CHIU_PHI_CU INT,
	@TEN_BP_CHIU_PHI nvarchar(50) ,
	@STATUS nvarchar(1)
AS
DECLARE @DONVI NVARCHAR(6)
SELECT TOP 1 @DONVI = MS_DON_VI FROM DON_VI WHERE MAC_DINH = 1

IF @STATUS = 'N'
BEGIN
	IF EXISTS (SELECT MS_BP_CHIU_PHI FROM BO_PHAN_CHIU_PHI WHERE MS_BP_CHIU_PHI = @MS_BP_CHIU_PHI)
	BEGIN
		UPDATE BO_PHAN_CHIU_PHI SET TEN_BP_CHIU_PHI = @TEN_BP_CHIU_PHI, GHI_CHU = @TEN_BP_CHIU_PHI
		WHERE MS_BP_CHIU_PHI = @MS_BP_CHIU_PHI 
	END
	ELSE
	BEGIN
		Set IDENTITY_INSERT BO_PHAN_CHIU_PHI ON
		INSERT INTO BO_PHAN_CHIU_PHI (MS_BP_CHIU_PHI, TEN_BP_CHIU_PHI,LOAI_CHI_PHI,MSDV,MA_BP_CHIU_PHI,GHI_CHU)
		VALUES( @MS_BP_CHIU_PHI, @TEN_BP_CHIU_PHI, 1,@DONVI,@MS_BP_CHIU_PHI,@TEN_BP_CHIU_PHI)
		Set IDENTITY_INSERT BO_PHAN_CHIU_PHI OFF
	END	
END

IF @STATUS = 'E'
BEGIN
	IF @MS_BP_CHIU_PHI = @MS_BP_CHIU_PHI_CU
	BEGIN
		UPDATE BO_PHAN_CHIU_PHI SET TEN_BP_CHIU_PHI = @TEN_BP_CHIU_PHI WHERE MS_BP_CHIU_PHI = @MS_BP_CHIU_PHI 
	END
	ELSE
	BEGIN
		EXEC spCapNhapMaBPCPhi @MS_BP_CHIU_PHI_CU,@MS_BP_CHIU_PHI 
		UPDATE BO_PHAN_CHIU_PHI SET TEN_BP_CHIU_PHI = @TEN_BP_CHIU_PHI WHERE MS_BP_CHIU_PHI = @MS_BP_CHIU_PHI 
	END
	
END	

IF @STATUS = 'D'
BEGIN
		DELETE BO_PHAN_CHIU_PHI WHERE MS_BP_CHIU_PHI = @MS_BP_CHIU_PHI 
END	