IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'INTEGRATION_TO_PHONG_BAN_UPDATE')
   exec('CREATE PROCEDURE [dbo].[INTEGRATION_TO_PHONG_BAN_UPDATE] AS BEGIN SET NOCOUNT ON; END')
GO


ALTER PROC [dbo].[INTEGRATION_TO_PHONG_BAN_UPDATE]	
	@MS_TO INT,
	@MS_TO_CU INT,
	@TEN_TO nvarchar(50) ,
	@STATUS nvarchar(1)
AS
DECLARE @DONVI NVARCHAR(6)
SELECT TOP 1 @DONVI = MS_DON_VI FROM DON_VI WHERE MAC_DINH = 1

IF @STATUS = 'N'
BEGIN
	IF EXISTS (SELECT MS_TO FROM TO_PHONG_BAN WHERE MS_TO = @MS_TO)
	BEGIN
		UPDATE TO_PHONG_BAN SET TEN_TO = @TEN_TO WHERE MS_TO = @MS_TO 
		UPDATE [TO] SET TEN_TO = @TEN_TO WHERE MS_TO = @MS_TO
	END
	ELSE
	BEGIN
		Set IDENTITY_INSERT TO_PHONG_BAN ON
		INSERT INTO TO_PHONG_BAN (MS_TO, TEN_TO,MS_DON_VI,MS_TO_INT)
		VALUES( @MS_TO, @TEN_TO,@DONVI,@MS_TO)
		Set IDENTITY_INSERT TO_PHONG_BAN OFF
	END	
END

IF @STATUS = 'E'
BEGIN
	IF @MS_TO <> @MS_TO_CU
	BEGIN
		EXEC spCapNhapMsTo @MS_TO_CU,@MS_TO
	END
	
	UPDATE TO_PHONG_BAN SET TEN_TO = @TEN_TO WHERE MS_TO = @MS_TO 
	UPDATE [TO] SET TEN_TO = @TEN_TO WHERE MS_TO = @MS_TO


END	

IF @STATUS = 'D'
BEGIN
	DELETE TO_PHONG_BAN WHERE MS_TO = @MS_TO 
	DELETE [TO] WHERE MS_TO = @MS_TO 
END	


IF @STATUS <> 'D'
BEGIN
	IF NOT EXISTS (SELECT MS_TO FROM [TO] WHERE MS_TO = @MS_TO)
	BEGIN
		Set IDENTITY_INSERT [TO] ON
		INSERT INTO [TO] (MS_TO,TEN_TO,MS_TO1)
		VALUES( @MS_TO, @TEN_TO,@MS_TO)
		Set IDENTITY_INSERT [TO] OFF
	END
END