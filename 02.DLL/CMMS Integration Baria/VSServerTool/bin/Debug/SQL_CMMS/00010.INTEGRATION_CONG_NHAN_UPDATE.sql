IF NOT EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'INTEGRATION_CONG_NHAN_UPDATE')
   exec('CREATE PROCEDURE [dbo].[INTEGRATION_CONG_NHAN_UPDATE] AS BEGIN SET NOCOUNT ON; END')
GO

ALTER PROC [dbo].[INTEGRATION_CONG_NHAN_UPDATE]	
	@MS_CONG_NHAN	nvarchar(9),
	@MS_CONG_NHAN_CU	nvarchar(9),
	@HO	nvarchar(30),
	@TEN	nvarchar(10),
	@NGAY_SINH	datetime,
	@NOI_SINH	nvarchar(255),
	@PHAI	bit,
	@DIA_CHI_THUONG_TRU	nvarchar(100),
	@SO_CMND	nvarchar(10),
	@MS_TO	int,
	@NGAY_VAO_LAM	datetime,
	@BO_VIEC	bit,
	@NGAY_NGHI_VIEC	datetime,
	@STATUS NVARCHAR(1)
AS

IF @NGAY_SINH = '1900-01-01 00:00:00.000'
BEGIN
	SET @NGAY_SINH = NULL
END

IF @NGAY_VAO_LAM = '1900-01-01 00:00:00.000'
BEGIN
	SET @NGAY_VAO_LAM = NULL
END

IF @NGAY_NGHI_VIEC = '1900-01-01 00:00:00.000'
BEGIN
	SET @NGAY_NGHI_VIEC = NULL
END
IF NOT EXISTS (SELECT MS_CONG_NHAN FROM CONG_NHAN WHERE MS_CONG_NHAN = @MS_CONG_NHAN)
BEGIN
	EXEC INTEGRATION_TO_PHONG_BAN_UPDATE @MS_TO,@MS_TO,@MS_TO,'N'
END

IF @STATUS = 'N'
BEGIN
	IF EXISTS (SELECT MS_CONG_NHAN FROM CONG_NHAN WHERE MS_CONG_NHAN = @MS_CONG_NHAN)
	BEGIN
		UPDATE CONG_NHAN SET HO = @HO,
				TEN = @TEN,
				NGAY_SINH = @NGAY_SINH,
				NOI_SINH = @NOI_SINH,
				PHAI = @PHAI,
				DIA_CHI_THUONG_TRU = @DIA_CHI_THUONG_TRU,
				SO_CMND = @SO_CMND,
				MS_TO = @MS_TO,
				NGAY_VAO_LAM = @NGAY_VAO_LAM,
				BO_VIEC = @BO_VIEC,
				NGAY_NGHI_VIEC = @NGAY_NGHI_VIEC
		WHERE MS_CONG_NHAN = @MS_CONG_NHAN 
	END
	ELSE
	BEGIN
		INSERT INTO CONG_NHAN(MS_CONG_NHAN,HO,TEN,NGAY_SINH,NOI_SINH,PHAI,DIA_CHI_THUONG_TRU,SO_CMND,MS_TO,NGAY_VAO_LAM,BO_VIEC,NGAY_NGHI_VIEC)
		VALUES(@MS_CONG_NHAN,@HO,@TEN,@NGAY_SINH,@NOI_SINH,@PHAI,@DIA_CHI_THUONG_TRU,@SO_CMND,@MS_TO,@NGAY_VAO_LAM,@BO_VIEC,@NGAY_NGHI_VIEC)
	END	
END
	
IF @STATUS = 'E'
BEGIN
	IF @MS_CONG_NHAN <> @MS_CONG_NHAN_CU
	BEGIN
		EXEC spCapNhapMaCongNhan @MS_CONG_NHAN_CU,@MS_CONG_NHAN
	END
	UPDATE CONG_NHAN SET HO = @HO,TEN = @TEN,NGAY_SINH = @NGAY_SINH,NOI_SINH = @NOI_SINH,
			PHAI = @PHAI,DIA_CHI_THUONG_TRU = @DIA_CHI_THUONG_TRU,
			SO_CMND = @SO_CMND,MS_TO = @MS_TO,NGAY_VAO_LAM = @NGAY_VAO_LAM,
			BO_VIEC = @BO_VIEC,NGAY_NGHI_VIEC = @NGAY_NGHI_VIEC
	WHERE MS_CONG_NHAN = @MS_CONG_NHAN 
END	

IF @STATUS = 'D'
BEGIN
	DELETE CONG_NHAN WHERE MS_CONG_NHAN = @MS_CONG_NHAN 
END