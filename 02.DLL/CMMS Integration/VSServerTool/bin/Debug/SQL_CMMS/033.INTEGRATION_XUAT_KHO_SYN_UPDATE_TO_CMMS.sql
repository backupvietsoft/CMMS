CREATE PROC [dbo].[INTEGRATION_XUAT_KHO_SYN_UPDATE_TO_CMMS]

AS

--SELECT DISTINCT MS_DH_XUAT_PT, NGAY, MS_KHO, UPDATE_DATE
--FROM dbo.SYN_TB_XUAT_KHO_INTEGRATION 
--WHERE ISNULL(DA_CHUYEN,CONVERT(BIT,0)) = CONVERT(BIT, 0)
--ORDER BY UPDATE_DATE , MS_DH_XUAT_PT ,NGAY 


DECLARE @MS_DH_XUAT_PT_FOR NVARCHAR(50)
DECLARE @NGAY_FOR DATETIME 
DECLARE @MS_KHO_FOR NVARCHAR(50)
DECLARE @UPDATE_DATE_FOR DATETIME


DECLARE PXK_SYN CURSOR FOR 
	SELECT DISTINCT MS_DH_XUAT_PT, NGAY, MS_KHO, UPDATE_DATE
	FROM dbo.SYN_TB_XUAT_KHO_INTEGRATION 
	WHERE ISNULL(DA_CHUYEN,CONVERT(BIT,0)) = CONVERT(BIT, 0)
	AND UPDATE_DATE IS NOT NULL
	ORDER BY UPDATE_DATE , MS_DH_XUAT_PT ,NGAY  
	
OPEN PXK_SYN
FETCH NEXT FROM PXK_SYN 
INTO @MS_DH_XUAT_PT_FOR, @NGAY_FOR,@MS_KHO_FOR,@UPDATE_DATE_FOR
WHILE @@FETCH_STATUS = 0
BEGIN

	--SELECT * FROM dbo.SYN_TB_XUAT_KHO_INTEGRATION  
	--WHERE 	MS_DH_XUAT_PT = @MS_DH_XUAT_PT_FOR AND NGAY = @NGAY_FOR AND MS_KHO= @MS_KHO_FOR AND UPDATE_DATE = @UPDATE_DATE_FOR
	DECLARE @MS_KHO_CMMS INT
	SELECT @MS_KHO_CMMS = MS_KHO  FROM IC_KHO WHERE MS_KHO_INT = ISNULL(@MS_KHO_FOR,0)
	
	-- XOA PHIEU XUAT CU DI
	DELETE dbo.SYN_TB_XUAT_KHO_CMMS 
	WHERE 	MS_DH_XUAT_PT = @MS_DH_XUAT_PT_FOR AND NGAY = @NGAY_FOR AND MS_KHO= @MS_KHO_CMMS AND UPDATE_DATE = @UPDATE_DATE_FOR
	
	-- CAP NHAT PHIEU XUAT MOI
	
	INSERT INTO dbo.SYN_TB_XUAT_KHO_CMMS (MS_DH_XUAT_PT, SO_PHIEU_XN, GIO, ROW_ID_NHAP, ROW_ID, NGAY, MS_KHO, TEN_KHO, MS_PT, SO_LUONG_CTU, SO_LUONG_THUC_XUAT, MS_DH_NHAP_PT, MS_VI_TRI, TEN_VI_TRI, 
                      MS_MAY, MS_DANG_XUAT, DANG_XUAT_VIET, NGUOI_NHAN, NGAY_CHUNG_TU, SO_CHUNG_TU, MS_PHIEU_BAO_TRI, GHI_CHU, LY_DO_XUAT, THU_KHO, MS_BP_CHIU_PHI, NGUOI_LAP, 
                      CAN_CU, DON_GIA, NGOAI_TE, TY_GIA, TY_GIA_USD, BAO_HANH_DEN_NGAY, XUAT_XU, INSERT_DATE, UPDATE_DATE, DA_CHUYEN, NGAY_CHUYEN)
	SELECT MS_DH_XUAT_PT, SO_PHIEU_XN, GIO, ROW_ID_NHAP, ROW_ID, NGAY, @MS_KHO_CMMS AS MS_KHO, TEN_KHO, MS_PT, SO_LUONG_CTU, SO_LUONG_THUC_XUAT, MS_DH_NHAP_PT, MS_VI_TRI, TEN_VI_TRI, 
                      MS_MAY, MS_DANG_XUAT, DANG_XUAT_VIET, NGUOI_NHAN, NGAY_CHUNG_TU, SO_CHUNG_TU, MS_PHIEU_BAO_TRI, GHI_CHU, LY_DO_XUAT, THU_KHO, MS_BP_CHIU_PHI, NGUOI_LAP, 
                      CAN_CU, DON_GIA, NGOAI_TE, TY_GIA, TY_GIA_USD, BAO_HANH_DEN_NGAY, XUAT_XU, INSERT_DATE, UPDATE_DATE, DA_CHUYEN, NGAY_CHUYEN
	FROM dbo.SYN_TB_XUAT_KHO_INTEGRATION  
	WHERE 	MS_DH_XUAT_PT = @MS_DH_XUAT_PT_FOR AND NGAY = @NGAY_FOR AND MS_KHO= @MS_KHO_FOR AND UPDATE_DATE = @UPDATE_DATE_FOR

	-- UPDATE TRANG THAI DA CHUYEN
	
	UPDATE dbo.SYN_TB_XUAT_KHO_INTEGRATION SET DA_CHUYEN = CONVERT(BIT,1)
	WHERE 	MS_DH_XUAT_PT = @MS_DH_XUAT_PT_FOR AND NGAY = @NGAY_FOR AND MS_KHO= @MS_KHO_FOR AND UPDATE_DATE = @UPDATE_DATE_FOR
	

	FETCH NEXT FROM PXK_SYN 
	INTO @MS_DH_XUAT_PT_FOR, @NGAY_FOR,@MS_KHO_FOR,@UPDATE_DATE_FOR
END 
CLOSE PXK_SYN;
DEALLOCATE PXK_SYN;