CREATE PROC [dbo].[INTEGRATION_GET_DATA_FOR_ALLOCATED_BY_PBT]
	@MS_MAY NVARCHAR(100),
	@MS_PHIEU_BAO_TRI NVARCHAR(100)
AS 

--DECLARE @MS_PHIEU_BAO_TRI NVARCHAR(100)
--SET @MS_PHIEU_BAO_TRI = 'WO-201312000002'
--DECLARE @MS_MAY NVARCHAR(100)
--SET @MS_MAY = 'BHCA-01'

SELECT TB_IN.MS_DH_XUAT_PT , TB_IN.MS_DH_NHAP_PT, TB_IN.MS_PT , TB_ICPT.TEN_PT , TB_ICPT.MS_PT_NCC , TB_ICPT.QUY_CACH, HSX.TEN_HSX, TB_IN.MS_KHO , 
IC_KHO.TEN_KHO, TB_IN.MS_MAY ,TB_IN.ROW_ID  as ID_XUAT , TB_IN.ROW_ID_NHAP  as ID_NHAP ,  LOAI_VT.VAT_TU, ISNULL(CVPT.MS_PT,'') AS MS_PT_CV , ISNULL(CTTBPT.MS_PT,'') AS MS_PT_MAY  ,
SUM (ISNULL(TB_IN.SO_LUONG_THUC_XUAT,0) - ISNULL(TB_ALLO.SO_LUONG_PHAN_BO,0)) + SUM(ISNULL(TB_ALLO_PBT.SO_LUONG_PHAN_BO_PBT,0)) AS SO_LUONG_AVAILABLE ,
SUM(ISNULL(TB_ALLO_PBT.SO_LUONG_PHAN_BO_PBT,0)) AS SL_YEU_CAU , TB_IN.DON_GIA ,TB_IN.NGOAI_TE , TB_IN.TY_GIA , TB_IN.TY_GIA_USD 
FROM 
(
SELECT MS_DH_XUAT_PT,ROW_ID , MS_MAY , MS_KHO , MS_PT, MS_DH_NHAP_PT , ROW_ID_NHAP , DON_GIA ,NGOAI_TE , TY_GIA , TY_GIA_USD  , SUM(ISNULL(SO_LUONG_THUC_XUAT,0)) AS SO_LUONG_THUC_XUAT  
FROM dbo.SYN_TB_XUAT_KHO_CMMS
GROUP BY MS_DH_XUAT_PT, ROW_ID, MS_MAY , MS_KHO , MS_PT, MS_DH_NHAP_PT , ROW_ID_NHAP, DON_GIA ,NGOAI_TE , TY_GIA , TY_GIA_USD 
) AS TB_IN LEFT JOIN 
(SELECT MS_DH_XUAT_PT, ROW_ID_XUAT, MS_PT, MS_DH_NHAP_PT ,  ROW_ID_NHAP , SUM(ISNULL(SO_LUONG_PHAN_BO,0)) AS SO_LUONG_PHAN_BO
FROM dbo.SYN_TB_ALLOCATION_VTPT_FOR_PBT
GROUP BY MS_DH_XUAT_PT, ROW_ID_XUAT, MS_PT, MS_DH_NHAP_PT , ROW_ID_NHAP ) AS TB_ALLO ON TB_IN.MS_DH_XUAT_PT =  TB_ALLO.MS_DH_XUAT_PT
AND TB_IN.MS_DH_NHAP_PT = TB_ALLO.MS_DH_NHAP_PT AND TB_IN.MS_PT = TB_ALLO.MS_PT AND TB_IN.ROW_ID = TB_ALLO.ROW_ID_XUAT 
AND TB_IN.ROW_ID_NHAP = TB_ALLO.ROW_ID_NHAP 
LEFT JOIN (SELECT MS_DH_XUAT_PT, ROW_ID_XUAT, MS_PT, MS_DH_NHAP_PT , ROW_ID_NHAP , SUM(ISNULL(SO_LUONG_PHAN_BO,0)) AS SO_LUONG_PHAN_BO_PBT
FROM dbo.SYN_TB_ALLOCATION_VTPT_FOR_PBT
WHERE MS_PHIEU_BT = @MS_PHIEU_BAO_TRI
GROUP BY MS_DH_XUAT_PT, ROW_ID_XUAT, MS_PT, MS_DH_NHAP_PT , ROW_ID_NHAP) AS TB_ALLO_PBT ON TB_IN.MS_DH_XUAT_PT =  TB_ALLO_PBT.MS_DH_XUAT_PT
AND TB_IN.MS_DH_NHAP_PT = TB_ALLO_PBT.MS_DH_NHAP_PT AND TB_IN.MS_PT = TB_ALLO_PBT.MS_PT AND TB_IN.ROW_ID = TB_ALLO_PBT.ROW_ID_XUAT 
AND TB_IN.ROW_ID_NHAP = TB_ALLO_PBT.ROW_ID_NHAP 
LEFT JOIN IC_PHU_TUNG AS TB_ICPT ON TB_IN.MS_PT = TB_ICPT.MS_PT
LEFT JOIN LOAI_VT ON TB_ICPT.MS_LOAI_VT = LOAI_VT.MS_LOAI_VT
LEFT JOIN (SELECT DISTINCT MS_PT FROM PHIEU_BAO_TRI_CONG_VIEC_PHU_TUNG WHERE MS_PHIEU_BAO_TRI = @MS_PHIEU_BAO_TRI) AS CVPT ON TB_IN.MS_PT = CVPT.MS_PT
LEFT JOIN (SELECT DISTINCT MS_PT FROM  CAU_TRUC_THIET_BI_PHU_TUNG WHERE MS_MAY = @MS_MAY) AS CTTBPT ON TB_IN.MS_PT = CTTBPT.MS_PT
LEFT JOIN HANG_SAN_XUAT AS HSX ON TB_ICPT.MS_HSX = HSX.MS_HSX
LEFT JOIN IC_KHO ON TB_IN.MS_KHO = IC_KHO.MS_KHO
GROUP BY TB_IN.MS_DH_XUAT_PT , TB_IN.MS_DH_NHAP_PT, TB_IN.MS_PT, TB_ICPT.TEN_PT , TB_ICPT.MS_PT_NCC , TB_ICPT.QUY_CACH , TB_IN.MS_KHO , IC_KHO.TEN_KHO , TB_IN.MS_MAY , TB_IN.ROW_ID , TB_IN.ROW_ID_NHAP ,LOAI_VT.VAT_TU ,
ISNULL(CVPT.MS_PT,'') , ISNULL(CTTBPT.MS_PT,''), HSX.TEN_HSX,TB_IN.DON_GIA ,TB_IN.NGOAI_TE , TB_IN.TY_GIA , TB_IN.TY_GIA_USD
HAVING SUM (ISNULL(TB_IN.SO_LUONG_THUC_XUAT,0) - ISNULL(TB_ALLO.SO_LUONG_PHAN_BO,0)) + SUM(ISNULL(TB_ALLO_PBT.SO_LUONG_PHAN_BO_PBT,0)) > 0 


--SELECT MS_MAY FROM PHIEU_BAO_TRI 


--SELECT MS_DH_NHAP_PT , ROW_ID , MS_PT , MS_KHO , DON_GIA ,  FROM SYN_TB_NHAP_KHO_CMMS