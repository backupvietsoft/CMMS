CREATE PROC [dbo].[INTEGRATION_CHECK_SO_LUONG_ALLOCATED_PBT]
	@MS_PHIEU_BT NVARCHAR(30)
AS

SELECT TB1.* FROM 
(SELECT TB_XUAT.MS_DH_XUAT_PT , TB_XUAT.ROW_ID AS ROW_ID_XUAT , TB_XUAT.MS_DH_NHAP_PT , TB_XUAT.ROW_ID_NHAP , TB_XUAT.MS_PT , 
SUM(ISNULL(TB_XUAT.SO_LUONG_THUC_XUAT,0))  AS SL_XUAT
FROM SYN_TB_XUAT_KHO_CMMS  AS TB_XUAT
INNER JOIN (SELECT  MS_DH_XUAT_PT ,ROW_ID_XUAT ,  MS_DH_NHAP_PT , MS_PT, ROW_ID_NHAP 
			FROM SYN_TB_ALLOCATION_VTPT_FOR_PBT  WHERE MS_PHIEU_BT = @MS_PHIEU_BT
) AS TBPB_PBT ON TB_XUAT.MS_DH_XUAT_PT = TB_XUAT.MS_DH_XUAT_PT AND TB_XUAT.MS_DH_NHAP_PT = TBPB_PBT.MS_DH_NHAP_PT
AND TB_XUAT.MS_PT = TBPB_PBT.MS_PT AND TB_XUAT.ROW_ID =TBPB_PBT.ROW_ID_XUAT AND TB_XUAT.ROW_ID_NHAP = TBPB_PBT.ROW_ID_NHAP
GROUP BY TB_XUAT.MS_DH_XUAT_PT , TB_XUAT.ROW_ID  , TB_XUAT.MS_DH_NHAP_PT , TB_XUAT.ROW_ID_NHAP , TB_XUAT.MS_PT
) AS TB1 LEFT JOIN  
(
SELECT  TBNOT_PBT.MS_DH_XUAT_PT ,TBNOT_PBT.ROW_ID_XUAT ,  TBNOT_PBT.MS_DH_NHAP_PT , TBNOT_PBT.ROW_ID_NHAP, TBNOT_PBT.MS_PT , 
SUM(ISNULL(TBNOT_PBT.SO_LUONG_PHAN_BO,0))  AS SL_PB
FROM SYN_TB_ALLOCATION_VTPT_FOR_PBT AS TBNOT_PBT 
INNER JOIN (SELECT DISTINCT MS_DH_XUAT_PT ,ROW_ID_XUAT ,  MS_DH_NHAP_PT , MS_PT, ROW_ID_NHAP 
			FROM SYN_TB_ALLOCATION_VTPT_FOR_PBT  WHERE MS_PHIEU_BT = @MS_PHIEU_BT
) AS TBPB_PBT ON TBNOT_PBT.MS_DH_XUAT_PT = TBPB_PBT.MS_DH_XUAT_PT AND TBNOT_PBT.MS_DH_NHAP_PT = TBPB_PBT.MS_DH_NHAP_PT
AND TBNOT_PBT.MS_PT = TBPB_PBT.MS_PT AND TBNOT_PBT.ROW_ID_XUAT =TBPB_PBT.ROW_ID_XUAT AND TBNOT_PBT.ROW_ID_NHAP = TBPB_PBT.ROW_ID_NHAP
GROUP BY TBNOT_PBT.MS_DH_XUAT_PT ,TBNOT_PBT.ROW_ID_XUAT ,  TBNOT_PBT.MS_DH_NHAP_PT , TBNOT_PBT.ROW_ID_NHAP, TBNOT_PBT.MS_PT
) AS TB2 ON TB1.MS_DH_XUAT_PT = TB2.MS_DH_XUAT_PT AND TB1.MS_DH_NHAP_PT = TB2.MS_DH_NHAP_PT
AND TB1.MS_PT = TB2.MS_PT AND TB1.ROW_ID_XUAT =TB2.ROW_ID_XUAT AND TB1.ROW_ID_NHAP = TB2.ROW_ID_NHAP
WHERE ISNULL(TB1.SL_XUAT,0) < ISNULL(TB2.SL_PB,0)
